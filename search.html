<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>宋溪资源站</title>
		<meta name="referrer" content="no-referrer">
		<link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
		<script src="https://unpkg.com/element-plus"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
		<link rel="stylesheet" type="text/css" href="search.css">
	</head>
	<body>
		<div class="head-bg"></div>
		<div id="app" v-cloak>
			<!-- 头部导航 -->
			<header class="header-container">
				<div class="header-content">
					<a href="index.html" class="logo-box">
						<i class="fas fa-cloud-download-alt logo-icon"></i>
						<div class="logo-text">宋溪资源站</div>
					</a>

					<div class="search-container">
						<input type="text" class="search-input" placeholder="输入电影、剧集、动漫等关键词..." v-model="keyword"
							@keyup.enter="search()">
						<button class="search-btn" @click="search(1)">
							<i class="fas fa-search"></i>
						</button>
					</div>

					<div class="nav-items">
						<div class="nav-item primary" @click="openSubmitDialog">
							<i class="fas fa-plus-circle"></i> 提交需求
						</div>
					</div>

					<button class="mobile-submit-btn" @click="openSubmitDialog">
						<i class="fas fa-plus-circle"></i>
						<span>提交需求</span>
					</button>
				</div>
			</header>

			<!-- 主体内容 -->
			<main class="main-container">
				<div class="search-results-container">
					<!-- 侧边栏筛选 -->
					<div class="results-sidebar">
						<div class="filter-section">
							<h3 class="filter-title">
								<i class="fas fa-filter"></i> 资源筛选
							</h3>
							<div class="filter-tags">
								<div v-for="t in ['全部','短剧','电影','电视剧','动漫','综艺']" :key="t" class="filter-tag"
									:class="{ active: filters.type === t }" @click="changeType(t)">{{ t }}</div>
							</div>
						</div>

						<div class="filter-section">
							<h3 class="filter-title">
								<i class="fas fa-sort-amount-down"></i> 排序方式
							</h3>
							<div class="filter-tags">
								<div v-for="s in ['相关度','最新','最热']" :key="s" class="filter-tag"
									:class="{ active: filters.sort === s }" @click="changeSort(s)">{{ s }}</div>
							</div>
						</div>
					</div>

					<!-- 主内容区 -->
					<div class="results-main">
						<div class="results-header">
							<h2 class="results-title">搜索结果：{{ keyword }}</h2>
							<div class="results-count">为您找到相关资源 {{ totalItems }} 条</div>
						</div>

						<!-- 搜索结果列表 -->
						<div class="results-list">
							<div v-if="loading" class="loading">
								<div class="spinner"></div>
								<span>加载中...</span>
							</div>
							<div v-else-if="results.length === 0" class="no-results">
								<i class="fas fa-search-minus"></i>
								<p>没有找到相关资源</p>
								<p class="no-results-hint">请尝试其他关键词或资源类型</p>
							</div>
							<!-- 修改后的卡片HTML -->
							<div v-for="(item, index) in results" :key="index" class="result-item">
								<h3 class="result-title">{{ item.title }}</h3>
								<div class="result-meta">
									<div class="result-meta-item">
										<i class="fas fa-calendar"></i> {{ item.updatedAt }}
									</div>
									<div class="result-source">
										<i class="fab fa-dropbox"></i> {{ item.source }}
									</div>
								</div>
								<button class="action-btn copy-btn" @click="copyToClipboard(item.link)">
									<i class="fas fa-share-alt"></i> 复制分享
								</button>
								<a class="action-btn visit-btn" @click.prevent="visitLink(item.link)">
									<i class="fas fa-external-link-alt"></i> 立即访问
								</a>


							</div>
							<el-pagination v-if="totalPages > 1" background layout="prev, pager, next"
								:total="totalItems" :page-size="pageSize" :current-page="currentPage"
								@current-change="handlePageChange">
							</el-pagination>
						</div>

					</div>
				</div>
			</main>

			<!-- 页脚 -->
			<footer class="footer-container">
				<div class="footer-content">
					<p class="footer-statement">
						声明：本站是网盘索引系统,所有内容均来自互联网所提供的公开引用资源，不存储、不传播任何文件，跳转链接指向网盘官网。
						文件内容请自行辨别，如发现违规请向网盘平台举报。本站仅供学习交流，无任何收费行为。
					</p>

					<div class="copyright">
						© 2025 宋溪资源站 - 让资源获取更简单
					</div>
				</div>
			</footer>

			<!-- 提交需求对话框 -->
			<el-dialog v-model="submitDialogVisible" title="提交资源需求" width="90%" :max-width="500"
				custom-class="resource-dialog">
				<el-input type="textarea" :rows="5" placeholder="请输入您想看的资源信息，我们会尽快添加~" v-model="resourceRequest">
				</el-input>
				<template #footer>
					<span class="dialog-footer">
						<el-button @click="submitDialogVisible = false">取消</el-button>
						<el-button type="primary" @click="submitResourceRequest">
							提交需求
						</el-button>
					</span>
				</template>
			</el-dialog>
		</div>
		<script>
			const {
				createApp
			} = Vue;
			const {
				ElMessage
			} = ElementPlus;

			const app = createApp({
				data() {
					return {
						categoryMap: { // 分类映射（后续可以改成动态获取）
							'全部': '',
							'短剧': '1',
							'电影': '2',
							'电视剧': '3',
							'动漫': '4',
							'综艺': '5'
						},
						currentPage: 1, // 当前页
						pageSize: 8, // 每页数量
						totalItems: 0, // 总条数
						totalPages: 0, // 总页数
						keyword: '', // 搜索关键词
						results: [], // 搜索结果
						loading: false, // 加载状态
						filters: { // 筛选条件
							type: '全部',
							sort: '相关度'
						}
					};
				},

				computed: {
					// 如果需要可以加额外计算属性
				},

				methods: {
					getKeywordFromURL() {
						const params = new URLSearchParams(window.location.search);
						return params.get('keyword') || '';
					},

					async search(page = 1) {
						if (!this.keyword.trim()) {
							ElMessage.error('请输入搜索关键词');
							return;
						}
						this.loading = true;
						try {
							this.currentPage = page;
							const params = {
								keyword: this.keyword,
								page: page - 1,
								size: this.pageSize
							};
							if (this.filters.type !== '全部') {
								params.categoryId = this.categoryMap[this.filters.type];
							}
							const res = await axios.get('http://192.168.1.25:8080/api/search', {
								params,
								withCredentials: true
							});
							if (res.data && res.data.code === 200) {
								this.results = res.data.data.content || [];
								this.totalItems = res.data.data.totalElements;
								this.totalPages = Math.ceil(this.totalItems / this.pageSize);
							} else {
								this.results = [];
								this.totalItems = 0;
								this.totalPages = 0;
								ElMessage.warning(res.data.message || '未找到相关资源');
							}
						} catch (error) {
							console.error(error);
							ElMessage.error('搜索失败，请稍后再试');
						} finally {
							this.loading = false;
						}
					},

					handlePageChange(page) {
						this.search(page);
					},

					changeType(type) {
						this.filters.type = type;
						this.search();
					},

					changeSort(sort) {
						this.filters.sort = sort;
						this.search();
					},


					async copyToClipboard(text) {
						if (!navigator.clipboard) {
							ElMessage.error("浏览器不支持剪贴板API");
							return;
						}
						try {
							await navigator.clipboard.writeText(text);
							ElMessage.success("复制成功");
							await fetch("http://192.168.1.25:8080/api/access/record", {
								method: "POST",
								headers: {
									"Content-Type": "application/json"
								},
								body: JSON.stringify({
									type: "copy",
									link: text
								})
							});
						} catch (e) {
							ElMessage.error("复制失败");
						}
					},

					async visitLink(link) {
						window.open(link, "_blank");
						try {
							await fetch("http://192.168.1.25:8080/api/access/record", {
								method: "POST",
								headers: {
									"Content-Type": "application/json"
								},
								body: JSON.stringify({
									type: "visit",
									link
								})
							});
						} catch (e) {
							console.error("访问统计失败", e);
						}
					}
				},

				mounted() {
					this.keyword = this.getKeywordFromURL();
					if (this.keyword) {
						this.search();
					}
				}
			});

			app.use(ElementPlus);
			app.mount('#app');
		</script>

	</body>

</html>
